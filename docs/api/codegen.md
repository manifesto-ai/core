# @manifesto-ai/codegen

> Plugin-based code generation from DomainSchema (TypeScript types + Zod schemas)

---

## Overview

`@manifesto-ai/codegen` generates type-safe TypeScript code from a Manifesto DomainSchema through a deterministic plugin pipeline.

Use this package when you need:

- TypeScript type definitions from your domain schema
- Zod runtime validators that match those types
- Deterministic, reproducible code generation in CI
- Custom output formats via the plugin system

---

## Main Entry Points

### generate()

Runs the codegen pipeline: plugins produce file patches, which are validated, collision-checked, and flushed to disk.

```typescript
import { generate, createTsPlugin, createZodPlugin } from "@manifesto-ai/codegen";

const result = await generate({
  schema,                                          // DomainSchema
  outDir: "./generated",                           // Output directory
  plugins: [createTsPlugin(), createZodPlugin()],  // Plugin array (order matters)
});

if (result.diagnostics.some(d => d.level === "error")) {
  // Error occurred — no files written to disk
}
```

`GenerateResult` includes:

- `files: Array<{ path: string; content: string }>` -- generated file contents
- `artifacts: Record<string, unknown>` -- plugin artifacts (namespaced by plugin name)
- `diagnostics: Diagnostic[]` -- warnings and errors

### createTsPlugin()

Generates TypeScript type definitions from `schema.types`.

```typescript
import { createTsPlugin } from "@manifesto-ai/codegen";

const plugin = createTsPlugin({
  typesFile: "types.ts",     // Default: "types.ts"
  actionsFile: "actions.ts", // Default: "actions.ts"
});
```

**Artifacts published:** `{ typeNames: string[], typeImportPath: string }`

### createZodPlugin()

Generates Zod schemas from `schema.types`. When run after the TS plugin, adds `z.ZodType<T>` annotations and type imports.

```typescript
import { createZodPlugin } from "@manifesto-ai/codegen";

const plugin = createZodPlugin({
  schemasFile: "base.ts", // Default: "base.ts"
});
```

---

## TypeDefinition Mapping

| Kind | TypeScript | Zod |
|------|-----------|-----|
| primitive (string) | `string` | `z.string()` |
| primitive (number) | `number` | `z.number()` |
| primitive (boolean) | `boolean` | `z.boolean()` |
| primitive (null) | `null` | `z.null()` |
| literal | `"value"` | `z.literal("value")` |
| array | `T[]` | `z.array(T)` |
| record | `Record<K, V>` | `z.record(K, V)` |
| object (top-level) | `export interface` | `z.object({ ... })` |
| union | `T1 \| T2` | `z.union([T1, T2])` |
| union (T \| null) | `T \| null` | `z.nullable(T)` |
| ref | `TypeName` | `z.lazy(() => TypeNameSchema)` |

---

## Plugin Utilities

For custom plugin authors:

```typescript
// Path validation (rejects traversal, absolute paths)
import { validatePath } from "@manifesto-ai/codegen";
const result = validatePath("sub/file.ts"); // { valid: true, normalized: "sub/file.ts" }

// Deterministic hash
import { stableHash } from "@manifesto-ai/codegen";
const hash = stableHash({ key: "value" }); // Same input -> same hash

// File header
import { generateHeader } from "@manifesto-ai/codegen";
const header = generateHeader({ schemaHash: "abc123" });
// "// @generated by @manifesto-ai/codegen — DO NOT EDIT\n// Source: ..."
```

---

## Related Packages

| Package | Relationship |
|---------|--------------|
| [@manifesto-ai/core](./core) | Provides DomainSchema, TypeDefinition types |
| [@manifesto-ai/compiler](./compiler) | Compiles MEL to DomainSchema (input to codegen) |

---

## Documentation

- **[Usage Guide](/guides/code-generation)** -- Step-by-step guide with examples
- **[Package GUIDE.md](https://github.com/manifesto-ai/core/blob/main/packages/codegen/docs/GUIDE.md)** -- Detailed package guide with custom plugin tutorial
- **[SPEC-v0.1.1](https://github.com/manifesto-ai/core/blob/main/packages/codegen/docs/SPEC-v0.1.1.md)** -- Normative specification
- **[ADR-CODEGEN-001](https://github.com/manifesto-ai/core/blob/main/packages/codegen/docs/ADR-CODEGEN-001.md)** -- Architecture decisions
